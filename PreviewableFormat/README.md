# PreviewableFormat

独自のraw形式だとwindowsの標準プレビューが働かなくて悲しい思いをすることがあります。

そこで、標準画像形式のメタデータにrawを埋め込んでしまおうと画策しました。今回はpngを使用しています

## PNGにデータの埋め込み

C#ではメタデータ埋め込みの命令として```InPlaceBitmapMetadataWriter```があるが、```SetQuery```で指定できる内容に制限がある様子で使い勝手はよくない。

難しいこと考えたくないよね

ということで、通常のpngデコーダをメモリーストリームに吐きだしてrawとがっちんこさせてしまいます。

### PNG構造

まず、前提としてPNGの構造に関して

#### ファイル

|ファイル先頭||||ファイル末尾|
|:--|:--|:--|:--|:--|
|PNGシグネチャ|チャンク|チャンク|チャンク|...|

で普通のファイルは必須チャンクを使用して

|ファイル先頭|||ファイル末尾|
|:--|:--|:--|:--|
|PNGシグネチャ|IHDR|IDAT|IEND|

みたいになっているのでデータを埋め込む場合IENDの前なんかにぶち込んでしまえば何とかなる

#### チャンク

必須チャンク
- IHDR
- PLTE（任意）
- IDAT
- IEND

使用可能なチャンク
- tRNS:透過
- cHRM:色度と白色点	 
- gAMA:イメージガンマ	 
- iCCP:埋め込みICCプロファイル	 
- sBIT:主要ビット	 
- sRGB:標準的なRGB色空間	 
- tEXt:テキストデータ	 
- zTXt:圧縮テキストデータ	 
- iTXt:国際テキストデータ	 
- bKGD:背景色	 
- hIST:画像のヒストグラム	 
- pHYs:ピクセル寸法	 
- sPLT:推奨パレット	 
- tIME:最終更新時刻

|チャンク先頭|||チャンク末尾|
|:--|:--|:--|:--|
|(データ部の)サイズ|タイプ|データ|CRC-32|
|Length|Chunk Type|Chunk Data|CRC|
|4Byte|4Byte|可変|4Byte|

チャンクの命名規則
- 1文字目 : 大文字=必須チャンク / 小文字=任意
- 2文字目 : 大文字=パブリック / 小文字=プライベート
- 3文字目 : かならず大文字
- 4文字目 : 大文字=複製可能（編集時コピー） / 小文字=複製不可（編集時破棄）

なのでプライベートチャンクとして

raWd

とかってする

#### CRC32

Chunk Type + Chunk DataでCRC32を計算する必要があります。おとなしくライブラリ使います

### 実装

rawからpngをまず吐かせて、IENDの前にぶち込んでいるだけです

ソースコードご参照

出力ファイル名は通常のpngと分けるためにraw.pngみたいな二重拡張子にしていますが、行儀は悪そうに見えるのでどうなんでしょうね。
